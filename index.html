<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>映画鑑賞アンケート</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html { scroll-behavior: smooth; }
        body { background-color: #f8fafc; color: #1f2937; font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif; }
        .step { display: none; }
        .step.active { display: block; animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .radio-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }

        /* 11段階評価（NPS）のスタイル調整 */
        .rating-grid {
            display: grid;
            grid-template-columns: repeat(11, 1fr);
            gap: 4px;
        }

        /* スマホで1行に収めるための調整 */
        @media (max-width: 640px) {
            .rating-grid { gap: 2px; }
            .rating-grid label {
                padding-left: 2px !important;
                padding-right: 2px !important;
                padding-top: 10px !important;
                padding-bottom: 10px !important;
                font-size: 10px !important;
            }
        }

        input[type="radio"]:checked + label, input[type="checkbox"]:checked + label {
            background-color: #1e293b;
            color: white;
            border-color: #1e293b;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        .req-mark { color: #ef4444; margin-left: 4px; }
        .has-error { border: 2px solid #ef4444 !important; background-color: #fef2f2 !important; border-radius: 1rem; padding: 1rem; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .terms-box {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            padding: 16px;
            font-size: 11px;
            line-height: 1.7;
            background: #fff;
            color: #475569;
            border-radius: 12px;
            text-align: left;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- ヘッダー -->
    <header id="headerArea" class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-2xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between mb-2">
                <span id="categoryLabel" class="text-xs font-bold text-blue-600 tracking-widest uppercase">ご鑑賞作品について</span>
                <span id="stepIndicator" class="text-lg font-black text-gray-900 tabular-nums">01 <span class="text-sm font-normal text-gray-400">/ 07</span></span>
            </div>
            <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden">
                <div id="progressBar" class="bg-blue-600 h-full w-0 transition-all duration-500 ease-out"></div>
            </div>
        </div>
    </header>

    <main class="flex-grow max-w-2xl mx-auto w-full px-6 py-10">
        <form id="surveyForm" class="space-y-12">

            <!-- STEP 1: ご鑑賞いただいた作品について -->
            <div id="step1" class="step active" data-step="1" data-label="ご鑑賞いただいた作品について">
                <h2 class="text-2xl font-bold mb-8 text-gray-800">ご鑑賞いただいた作品について</h2>

                <div class="mb-10 question-block">
                    <label class="block text-sm font-bold mb-3 text-gray-700">Q1. ご覧になった作品を教えてください。<span class="req-mark">＊</span></label>
                    <div class="radio-grid mb-4">
                        <input type="radio" name="作品名" id="m1" value="グラディエーターII 英雄再臨" onchange="toggleQ1Other(this)" class="hidden" required><label for="m1" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">グラディエーターII 英雄再臨</label>
                        <input type="radio" name="作品名" id="m2" value="正体" onchange="toggleQ1Other(this)" class="hidden"><label for="m2" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">正体</label>
                        <input type="radio" name="作品名" id="m3" value="劇場版ドクターX" onchange="toggleQ1Other(this)" class="hidden"><label for="m3" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">劇場版ドクターX</label>
                        <input type="radio" name="作品名" id="m4" value="モアナと伝説の海２" onchange="toggleQ1Other(this)" class="hidden"><label for="m4" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">モアナと伝説の海２</label>
                        <input type="radio" name="作品名" id="m5" value="ライオン・キング：ムファサ" onchange="toggleQ1Other(this)" class="hidden"><label for="m5" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">ライオン・キング：ムファサ</label>
                        <input type="radio" name="作品名" id="m6" value="聖☆おにいさん THE MOVIE" onchange="toggleQ1Other(this)" class="hidden"><label for="m6" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">聖☆おにいさん THE MOVIE</label>
                        <input type="radio" name="作品名" id="m7" value="ロード・オブ・ザ・リング／ローハンの戦い" onchange="toggleQ1Other(this)" class="hidden"><label for="m7" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">ロード・オブ・ザ・リング／ローハンの戦い</label>
                        <input type="radio" name="作品名" id="m8" value="はたらく細胞" onchange="toggleQ1Other(this)" class="hidden"><label for="m8" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">はたらく細胞</label>
                        <input type="radio" name="作品名" id="m9" value="ウィキッド ふたりの魔女" onchange="toggleQ1Other(this)" class="hidden"><label for="m9" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">ウィキッド ふたりの魔女</label>
                        <input type="radio" name="作品名" id="m10" value="矢野くんの普通の日々" onchange="toggleQ1Other(this)" class="hidden"><label for="m10" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">矢野くんの普通の日々</label>
                        <input type="radio" name="作品名" id="m11" value="あんさんぶるスターズ！！ライブビューイング" onchange="toggleQ1Other(this)" class="hidden"><label for="m11" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">あんさんぶるスターズ！！ライブビューイング</label>
                        <input type="radio" name="作品名" id="m_other" value="その他" onchange="toggleQ1Other(this)" class="hidden"><label for="m_other" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">その他</label>
                    </div>
                    <div id="q1_other_container" class="hidden">
                        <input type="text" id="q1_other_input" name="作品名_自由入力" class="w-full p-4 border border-gray-200 rounded-xl bg-white outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all" placeholder="作品名をご記入ください">
                    </div>
                </div>

                <div class="mb-10 question-block">
                    <label class="block text-sm font-bold mb-3 text-gray-700">Q2. ご覧になった上映フォーマットをお聞かせください。<span class="req-mark">＊</span></label>
                    <div class="radio-grid mb-6">
                        <input type="radio" name="フォーマット" id="f1" value="通常上映" class="hidden" required><label for="f1" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">通常上映</label>
                        <input type="radio" name="フォーマット" id="f2" value="IMAX" class="hidden"><label for="f2" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">IMAX</label>
                        <input type="radio" name="フォーマット" id="f3" value="Dolby Cinema" class="hidden"><label for="f3" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">Dolby Cinema</label>
                        <input type="radio" name="フォーマット" id="f4" value="4DX/MX4D" class="hidden"><label for="f4" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">4DX/MX4D</label>
                        <input type="radio" name="フォーマット" id="f5" value="ULTRA 4DX" class="hidden"><label for="f5" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">ULTRA 4DX</label>
                        <input type="radio" name="フォーマット" id="f6" value="ScreenX" class="hidden"><label for="f6" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">ScreenX</label>
                        <input type="radio" name="フォーマット" id="f7" value="その他" class="hidden"><label for="f7" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">その他</label>
                    </div>

                    <!-- 字幕・吹替の選択肢 -->
                    <div class="mt-6 pt-6 border-t border-gray-100">
                        <p class="text-[10px] font-bold text-gray-400 mb-3 tracking-wider uppercase">（洋画を鑑賞の場合）</p>
                        <div class="radio-grid">
                            <input type="radio" name="音声形式" id="voice1" value="字幕" onclick="toggleRadio(this)" class="hidden"><label for="voice1" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">字幕</label>
                            <input type="radio" name="音声形式" id="voice2" value="吹替" onclick="toggleRadio(this)" class="hidden"><label for="voice2" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">吹替</label>
                        </div>
                    </div>
                </div>

                <div class="mb-10 question-block">
                    <label class="block text-sm font-bold mb-3 text-gray-700">Q3. この作品をご覧になるのは、何度目ですか？<span class="req-mark">＊</span></label>
                    <div class="radio-grid">
                        <input type="radio" name="鑑賞回数" id="c1" value="初めて" class="hidden" required><label for="c1" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">初めて</label>
                        <input type="radio" name="鑑賞回数" id="c2" value="2回目" class="hidden"><label for="c2" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">2回目</label>
                        <input type="radio" name="鑑賞回数" id="c3" value="3回目" class="hidden"><label for="c3" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">3回目</label>
                        <input type="radio" name="鑑賞回数" id="c4" value="4回目" class="hidden"><label for="c4" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">4回目</label>
                        <input type="radio" name="鑑賞回数" id="c5" value="5回目以上" class="hidden"><label for="c5" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">5回目以上</label>
                    </div>
                </div>

                <div class="mb-10 question-block">
                    <label class="block text-sm font-bold mb-3 text-gray-700">Q4. あなたは、この作品を『もう一度、映画館で』鑑賞したいと思いますか？<span class="req-mark">＊</span></label>
                    <div class="space-y-3">
                        <div class="flex items-center"><input type="radio" name="リピート意向" id="r1" value="ぜひもう一度映画館で観たい" class="mr-3" required><label for="r1" class="text-sm">ぜひもう一度映画館で観たい</label></div>
                        <div class="flex items-center"><input type="radio" name="リピート意向" id="r2" value="別フォーマットでもう一度観たい" class="mr-3"><label for="r2" class="text-sm">別フォーマット（IMAXや4DXなど）でもう一度観たい</label></div>
                        <div class="flex items-center"><input type="radio" name="リピート意向" id="r6" value="イベント上映でもう一度観たい" class="mr-3"><label for="r6" class="text-sm">イベント上映（応援上映など）でもう一度観たい</label></div>
                        <div class="flex items-center"><input type="radio" name="リピート意向" id="r7" value="新たな入場者プレゼントがあればもう一度観たい" class="mr-3"><label for="r7" class="text-sm">新たな入プレがあればもう一度観たい</label></div>
                        <div class="flex items-center"><input type="radio" name="リピート意向" id="r3" value="機会があれば観るかもしれない" class="mr-3"><label for="r3" class="text-sm">機会があれば観るかもしれない</label></div>
                        <div class="flex items-center"><input type="radio" name="リピート意向" id="r4" value="映画館では観ない" class="mr-3"><label for="r4" class="text-sm">映画館では観ない（配信やレンタルで観れば十分）</label></div>
                        <div class="flex items-center"><input type="radio" name="リピート意向" id="r5" value="もう一度観ることはない" class="mr-3"><label for="r5" class="text-sm">もう一度観ることはない</label></div>
                    </div>
                </div>

                <div class="mb-10 question-block">
                    <label class="block text-sm font-bold mb-3 text-gray-700">Q5. この作品の満足度はいかがでしたか？<span class="req-mark">＊</span></label>
                    <div class="flex gap-2">
                        <div class="flex-1 flex flex-col items-center">
                            <input type="radio" name="作品満足度" id="satisfaction1" value="1" class="hidden" required>
                            <label for="satisfaction1" class="border border-gray-200 py-3 w-full max-w-[48px] rounded-xl text-center cursor-pointer hover:border-blue-300 transition-all text-xs bg-white">1</label>
                            <span class="text-[9px] text-gray-400 mt-2 text-center leading-tight">とても不満</span>
                        </div>
                        <div class="flex-1 flex flex-col items-center">
                            <input type="radio" name="作品満足度" id="satisfaction2" value="2" class="hidden">
                            <label for="satisfaction2" class="border border-gray-200 py-3 w-full max-w-[48px] rounded-xl text-center cursor-pointer hover:border-blue-300 transition-all text-xs bg-white">2</label>
                        </div>
                        <div class="flex-1 flex flex-col items-center">
                            <input type="radio" name="作品満足度" id="satisfaction3" value="3" class="hidden">
                            <label for="satisfaction3" class="border border-gray-200 py-3 w-full max-w-[48px] rounded-xl text-center cursor-pointer hover:border-blue-300 transition-all text-xs bg-white">3</label>
                            <span class="text-[9px] text-gray-400 mt-2 text-center leading-tight">ふつう</span>
                        </div>
                        <div class="flex-1 flex flex-col items-center">
                            <input type="radio" name="作品満足度" id="satisfaction4" value="4" class="hidden">
                            <label for="satisfaction4" class="border border-gray-200 py-3 w-full max-w-[48px] rounded-xl text-center cursor-pointer hover:border-blue-300 transition-all text-xs bg-white">4</label>
                        </div>
                        <div class="flex-1 flex flex-col items-center">
                            <input type="radio" name="作品満足度" id="satisfaction5" value="5" class="hidden">
                            <label for="satisfaction5" class="border border-gray-200 py-3 w-full max-w-[48px] rounded-xl text-center cursor-pointer hover:border-blue-300 transition-all text-xs bg-white">5</label>
                            <span class="text-[9px] text-gray-400 mt-2 text-center leading-tight">とても満足</span>
                        </div>
                    </div>
                </div>

                <div class="mb-10 question-block">
                    <label class="block text-sm font-bold mb-3 text-gray-700">Q6. ご覧になった作品を、他の人に勧める可能性はどのくらいありますか？<span class="req-mark">＊</span></label>
                    <div id="q5-container" class="rating-grid"></div>
                    <div class="flex justify-between mt-2 text-[10px] text-gray-400 font-bold px-1"><span>0点（全く勧めない）</span><span>10点（強く勧める）</span></div>
                </div>

                <div class="mb-10 question-block">
                    <label class="block text-sm font-bold mb-3 text-gray-700">Q7. 作品の中で、特に印象に残った点があれば教えてください。（任意）</label>
                    <textarea name="感想_具体" rows="3" class="w-full p-4 border border-gray-200 rounded-xl bg-white outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all" placeholder="シーン、セリフ、気に入ったポイントなど"></textarea>
                </div>
            </div>

            <!-- STEP 2: 今回のご来場について -->
            <div id="step2" class="step" data-step="2" data-label="今回の来場について">
                <h2 class="text-2xl font-bold mb-8 text-gray-800">今回の来場について</h2>

                <div class="mb-10 question-block">
                    <label class="block text-sm font-bold mb-3 text-gray-700">Q8. 本日は、どなたとご覧になりましたか？<span class="req-mark">＊</span></label>
                    <div class="radio-grid">
                        <input type="radio" name="同行者" id="t1" value="1人で" onchange="toggleQ8(this)" class="hidden" required><label for="t1" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">1人で</label>
                        <input type="radio" name="同行者" id="t2" value="友人・知人と" onchange="toggleQ8(this)" class="hidden"><label for="t2" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">友人・知人と</label>
                        <input type="radio" name="同行者" id="t3" value="恋人・パートナーと" onchange="toggleQ8(this)" class="hidden"><label for="t3" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">恋人・パートナーと</label>
                        <input type="radio" name="同行者" id="t4" value="家族・親族と" onchange="toggleQ8(this)" class="hidden"><label for="t4" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">家族・親族と</label>
                        <input type="radio" name="同行者" id="t5" value="その他" onchange="toggleQ8(this)" class="hidden"><label for="t5" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">その他</label>
                    </div>
                </div>

                <div class="mb-10 question-block" id="q8-block" style="display: none;">
                    <label class="block text-sm font-bold mb-3 text-gray-700">Q9. 【2名以上でご覧の方】ご自身を含めた合計人数は何名ですか？<span class="req-mark">＊</span></label>
                    <div class="radio-grid">
                        <input type="radio" name="合計人数" id="p1" value="2人" onchange="toggleQ9(this)" class="hidden"><label for="p1" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">2人</label>
                        <input type="radio" name="合計人数" id="p2" value="3人" onchange="toggleQ9(this)" class="hidden"><label for="p2" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">3人</label>
                        <input type="radio" name="合計人数" id="p3" value="4人" onchange="toggleQ9(this)" class="hidden"><label for="p3" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">4人</label>
                        <input type="radio" name="合計人数" id="p4" value="5人以上" onchange="toggleQ9(this)" class="hidden"><label for="p4" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">5人以上</label>
                    </div>
                </div>

                <div class="mb-10 question-block" id="q9-block" style="display: none;">
                    <label class="block text-sm font-bold mb-3 text-gray-700">
                        Q10. 【2名以上でご覧の方】ご一緒した方の年代を、当てはまるものすべて選んでください。（複数選択可、人数分まで）<span class="req-mark">＊</span>
                    </label>
                    <div class="space-y-2" id="companion-age-checkboxes">
                        <div class="flex items-center"><input type="checkbox" name="同伴者年代" id="comp_age1" value="15歳未満" class="mr-3"><label for="comp_age1" class="text-sm">15歳未満</label></div>
                        <div class="flex items-center"><input type="checkbox" name="同伴者年代" id="comp_age2" value="15～19歳" class="mr-3"><label for="comp_age2" class="text-sm">15～19歳</label></div>
                        <div class="flex items-center"><input type="checkbox" name="同伴者年代" id="comp_age3" value="20代" class="mr-3"><label for="comp_age3" class="text-sm">20代</label></div>
                        <div class="flex items-center"><input type="checkbox" name="同伴者年代" id="comp_age4" value="30代" class="mr-3"><label for="comp_age4" class="text-sm">30代</label></div>
                        <div class="flex items-center"><input type="checkbox" name="同伴者年代" id="comp_age5" value="40代" class="mr-3"><label for="comp_age5" class="text-sm">40代</label></div>
                        <div class="flex items-center"><input type="checkbox" name="同伴者年代" id="comp_age6" value="50代" class="mr-3"><label for="comp_age6" class="text-sm">50代</label></div>
                        <div class="flex items-center"><input type="checkbox" name="同伴者年代" id="comp_age7" value="60代" class="mr-3"><label for="comp_age7" class="text-sm">60代</label></div>
                        <div class="flex items-center"><input type="checkbox" name="同伴者年代" id="comp_age8" value="70代以上" class="mr-3"><label for="comp_age8" class="text-sm">70代以上</label></div>
                        <div class="text-xs text-gray-400 mt-1" id="companion-age-limit-hint"></div>
                    </div>
                    <script>
                        // 上限値を保持
                        let companionAgeMax = null;

                        function setCompanionAgeMax(max) {
                            companionAgeMax = max;
                            updateCompanionAgeHint();
                            // チェックボックスの状態を更新
                            const checkboxes = document.querySelectorAll('input[name="同伴者年代"]');
                            checkboxes.forEach(cb => cb.disabled = false);
                            // nullの場合は制限なし
                            if (companionAgeMax !== null) {
                                const checked = [...checkboxes].filter(cb => cb.checked);
                                if (checked.length >= companionAgeMax) {
                                    checkboxes.forEach(cb => {
                                        if (!cb.checked) cb.disabled = true;
                                    });
                                }
                            }
                        }

                        function updateCompanionAgeHint() {
                            const hint = document.getElementById('companion-age-limit-hint');
                            if (companionAgeMax !== null) {
                                hint.textContent = `最大${companionAgeMax}個まで選択できます。`;
                            } else {
                                hint.textContent = 'いくつでも選択できます。';
                            }
                        }

                        // 人数選択による上限反映イベント
                        function updateCompanionAgeLimitFromRadio() {
                            const p2 = document.getElementById('p1');
                            const p3 = document.getElementById('p2');
                            const p4 = document.getElementById('p3');
                            const p5 = document.getElementById('p4');
                            if (p2 && p2.checked) {
                                setCompanionAgeMax(1); // 2人 - 1 = 1人
                            } else if (p3 && p3.checked) {
                                setCompanionAgeMax(2); // 3人 - 1 = 2人
                            } else if (p4 && p4.checked) {
                                setCompanionAgeMax(3); // 4人 - 1 = 3人
                            } else if (p5 && p5.checked) {
                                setCompanionAgeMax(null); // 5人以上の場合は制限なし
                            }
                        }

                        // チェックボックス選択時の監視
                        document.addEventListener('change', function(e) {
                            if (e.target && e.target.name === "合計人数") {
                                updateCompanionAgeLimitFromRadio();
                                setTimeout(() => {
                                    const boxes = document.querySelectorAll('input[name="同伴者年代"]');
                                    const checked = [...boxes].filter(cb => cb.checked);
                                    // companionAgeMaxがnull（「5人以上」）の場合は無制限なのでチェック数制限しない
                                    if (companionAgeMax !== null && checked.length > companionAgeMax) {
                                        checked.slice(companionAgeMax).forEach(cb => cb.checked = false);
                                    }
                                    // 5人以上（companionAgeMax = null）ならすべて有効化
                                    if (companionAgeMax === null) {
                                        boxes.forEach(cb => cb.disabled = false);
                                    }
                                }, 100);
                            }
                            if (e.target && e.target.name === "同伴者年代" && companionAgeMax !== null) {
                                const boxes = document.querySelectorAll('input[name="同伴者年代"]');
                                const checked = [...boxes].filter(cb => cb.checked);
                                if (checked.length >= companionAgeMax) {
                                    boxes.forEach(cb => {
                                        if (!cb.checked) cb.disabled = true;
                                    });
                                } else {
                                    boxes.forEach(cb => cb.disabled = false);
                                }
                            }
                        });

                        // 初期化
                        window.addEventListener('DOMContentLoaded', function() {
                            updateCompanionAgeLimitFromRadio();
                        });
                    </script>
                </div>

                <div class="mb-10 question-block">
                    <label class="block text-sm font-bold mb-3 text-gray-700">Q11. 今回の映画を観に行くことは、いつ頃決めましたか？<span class="req-mark">＊</span></label>
                    <div class="radio-grid">
                        <input type="radio" name="決定時期" id="d1" value="当日" class="hidden" required><label for="d1" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">当日</label>
                        <input type="radio" name="決定時期" id="d2" value="2～3日前" class="hidden"><label for="d2" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">2～3日前</label>
                        <input type="radio" name="決定時期" id="d3" value="1週間前" class="hidden"><label for="d3" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">1週間前</label>
                        <input type="radio" name="決定時期" id="d4" value="それ以上前" class="hidden"><label for="d4" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">それ以上前</label>
                    </div>
                </div>

                <div class="mb-10 question-block">
                    <label class="block text-sm font-bold mb-3 text-gray-700">Q12. チケットはどのように購入されましたか？<span class="req-mark">＊</span></label>
                    <div class="space-y-2">
                        <div class="flex items-center"><input type="radio" name="購入方法" id="k1" value="当日窓口" class="mr-3" required><label for="k1" class="text-sm">当日窓口で</label></div>
                        <div class="flex items-center"><input type="radio" name="購入方法" id="k2" value="劇場の公式サイト" class="mr-3"><label for="k2" class="text-sm">劇場の公式サイトで</label></div>
                        <div class="flex items-center"><input type="radio" name="購入方法" id="k3" value="前売り券（ムビチケ）" class="mr-3"><label for="k3" class="text-sm">前売り券（ムビチケ）を購入</label></div>
                        <div class="flex items-center"><input type="radio" name="購入方法" id="k4" value="映画GIFT" class="mr-3"><label for="k4" class="text-sm">映画GIFTを購入</label></div>
                        <div class="flex items-center"><input type="radio" name="購入方法" id="k5" value="映画サイト" class="mr-3"><label for="k5" class="text-sm">映画サイトで</label></div>
                        <div class="flex items-center"><input type="radio" name="購入方法" id="k6" value="その他" class="mr-3"><label for="k6" class="text-sm">その他</label></div>
                    </div>
                </div>

                <div class="mb-10 question-block">
                    <label class="block text-sm font-bold mb-3 text-gray-700">Q13. どのような手段で映画館までお越しになりましたか？<span class="req-mark">＊</span></label>
                    <div class="radio-grid">
                        <input type="radio" name="来場手段" id="s1" value="電車" class="hidden" required><label for="s1" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">電車</label>
                        <input type="radio" name="来場手段" id="s2" value="バス" class="hidden"><label for="s2" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">バス</label>
                        <input type="radio" name="来場手段" id="s3" value="自家用車" class="hidden"><label for="s3" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">自家用車</label>
                        <input type="radio" name="来場手段" id="s4" value="自転車" class="hidden"><label for="s4" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">自転車</label>
                        <input type="radio" name="来場手段" id="s5" value="徒歩" class="hidden"><label for="s5" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">徒歩</label>
                        <input type="radio" name="来場手段" id="s6" value="タクシー" class="hidden"><label for="s6" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">タクシー</label>
                        <input type="radio" name="来場手段" id="s7" value="その他" class="hidden"><label for="s7" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">その他</label>
                    </div>
                </div>

                <div class="mb-10 question-block">
                    <label class="block text-sm font-bold mb-3 text-gray-700">Q14. 映画館まで片道どのくらいかかりましたか？<span class="req-mark">＊</span></label>
                    <div class="space-y-2">
                        <div class="flex items-center"><input type="radio" name="来場時間" id="h1" value="15分未満" class="mr-3" required><label for="h1" class="text-sm">15分未満</label></div>
                        <div class="flex items-center"><input type="radio" name="来場時間" id="h2" value="15分〜30分未満" class="mr-3"><label for="h2" class="text-sm">15分〜30分未満</label></div>
                        <div class="flex items-center"><input type="radio" name="来場時間" id="h3" value="30分〜1時間未満" class="mr-3"><label for="h3" class="text-sm">30分〜1時間未満</label></div>
                        <div class="flex items-center"><input type="radio" name="来場時間" id="h4" value="1時間〜1時間半未満" class="mr-3"><label for="h4" class="text-sm">1時間〜1時間半未満</label></div>
                        <div class="flex items-center"><input type="radio" name="来場時間" id="h5" value="1時間半以上" class="mr-3"><label for="h5" class="text-sm">1時間半以上</label></div>
                    </div>
                </div>
            </div>

            <!-- STEP 3: 来場のきっかけについて -->
            <div id="step3" class="step" data-step="3" data-label="来場のきっかけについて">
                <h2 class="text-2xl font-bold mb-8 text-gray-800">来場のきっかけについて</h2>

                <div class="mb-10 question-block">
                    <label class="block text-sm font-bold mb-3 text-gray-700">Q15. この作品の情報を最初に知ったのは何ですか？<span class="req-mark">＊</span></label>
                    <div class="space-y-2">
                        <div class="flex items-center"><input type="radio" name="認知媒体" id="n1" value="劇場予告" class="mr-3" required><label for="n1" class="text-sm">劇場での予告編</label></div>
                        <div class="flex items-center"><input type="radio" name="認知媒体" id="n2" value="テレビCM" class="mr-3"><label for="n2" class="text-sm">テレビCM</label></div>
                        <div class="flex items-center"><input type="radio" name="認知媒体" id="n3" value="テレビ番組" class="mr-3"><label for="n3" class="text-sm">テレビの情報番組・バラエティ</label></div>
                        <div class="flex items-center"><input type="radio" name="認知媒体" id="n4" value="YouTube" class="mr-3"><label for="n4" class="text-sm">YouTube</label></div>
                        <div class="flex items-center"><input type="radio" name="認知媒体" id="n5" value="X(旧Twitter)" class="mr-3"><label for="n5" class="text-sm">X(旧Twitter)</label></div>
                        <div class="flex items-center"><input type="radio" name="認知媒体" id="n6" value="Instagram" class="mr-3"><label for="n6" class="text-sm">Instagram</label></div>
                        <div class="flex items-center"><input type="radio" name="認知媒体" id="n7" value="TikTok" class="mr-3"><label for="n7" class="text-sm">TikTok</label></div>
                        <div class="flex items-center"><input type="radio" name="認知媒体" id="n8" value="映画情報サイト" class="mr-3"><label for="n8" class="text-sm">映画情報サイト／アプリ（映画.com, Filmarksなど）</label></div>
                        <div class="flex items-center"><input type="radio" name="認知媒体" id="n9" value="Webニュース" class="mr-3"><label for="n9" class="text-sm">Webニュース／記事</label></div>
                        <div class="flex items-center"><input type="radio" name="認知媒体" id="n10" value="公式サイト" class="mr-3"><label for="n10" class="text-sm">作品や劇場の公式サイト</label></div>
                        <div class="flex items-center"><input type="radio" name="認知媒体" id="n13" value="雑誌" class="mr-3"><label for="n13" class="text-sm">雑誌・新聞などの紙媒体</label></div>
                        <div class="flex items-center"><input type="radio" name="認知媒体" id="n14" value="ラジオ" class="mr-3"><label for="n14" class="text-sm">ラジオ</label></div>
                        <div class="flex items-center"><input type="radio" name="認知媒体" id="n11" value="口コミ" class="mr-3"><label for="n11" class="text-sm">友人／家族からの口コミ</label></div>
                        <div class="flex items-center"><input type="radio" name="認知媒体" id="n16" value="配信サービス" class="mr-3"><label for="n16" class="text-sm">配信サービス（Netflix, Amazon Primeなど）</label></div>
                        <div class="flex items-center"><input type="radio" name="認知媒体" id="n18" value="その他" class="mr-3"><label for="n18" class="text-sm">その他</label></div>
                    </div>
                </div>

                <div class="mb-10 question-block">
                    <label class="block text-sm font-bold mb-3 text-gray-700">Q16. この作品を観ようと決めた、一番の理由は何ですか？<span class="req-mark">＊</span></label>
                    <div class="space-y-2">
                        <div class="flex items-center"><input type="radio" name="決定理由" id="g1" value="キャスト・監督" class="mr-3" required><label for="g1" class="text-sm">好きな監督・俳優が出演</label></div>
                        <div class="flex items-center"><input type="radio" name="決定理由" id="g2" value="予告編" class="mr-3"><label for="g2" class="text-sm">予告編が面白そうだった</label></div>
                        <div class="flex items-center"><input type="radio" name="決定理由" id="g3" value="あらすじ" class="mr-3"><label for="g3" class="text-sm">あらすじ・ストーリーに惹かれた</label></div>
                        <div class="flex items-center"><input type="radio" name="決定理由" id="g4" value="原作" class="mr-3"><label for="g4" class="text-sm">原作・シリーズのファン</label></div>
                        <div class="flex items-center"><input type="radio" name="決定理由" id="g5" value="勧められた" class="mr-3"><label for="g5" class="text-sm">家族や友人から勧められた</label></div>
                        <div class="flex items-center"><input type="radio" name="決定理由" id="g6" value="評判" class="mr-3"><label for="g6" class="text-sm">世間の評判・レビューが高かった</label></div>
                        <div class="flex items-center"><input type="radio" name="決定理由" id="g7" value="上映形式" class="mr-3"><label for="g7" class="text-sm">特別な上映形式（IMAX, 4DXなど）</label></div>
                        <div class="flex items-center"><input type="radio" name="決定理由" id="g9" value="主題歌・音楽" class="mr-3"><label for="g9" class="text-sm">主題歌・音楽に惹かれた</label></div>
                        <div class="flex items-center"><input type="radio" name="決定理由" id="g10" value="ビジュアル" class="mr-3"><label for="g10" class="text-sm">ビジュアル・ポスターが印象的だった</label></div>
                        <div class="flex items-center"><input type="radio" name="決定理由" id="g8" value="その他" class="mr-3"><label for="g8" class="text-sm">その他</label></div>
                    </div>
                </div>
            </div>

            <!-- STEP 4: 劇場体験の評価 (Q15, 17) -->
            <div id="step4" class="step" data-step="4" data-label="劇場体験の評価">
                <h2 class="text-2xl font-bold mb-8 text-gray-800">劇場体験の評価</h2>

                <div class="mb-14 question-block">
                    <label class="block text-sm font-bold mb-3 text-gray-700">Q17. この映画館を家族や友人にどの程度おすすめしたいですか？<span class="req-mark">＊</span></label>
                    <div id="q15-container" class="rating-grid"></div>
                    <div class="flex justify-between mt-2 text-[10px] text-gray-400 font-bold px-1"><span>0点（全く勧めない）</span><span>10点（強く勧める）</span></div>
                </div>

                <div class="mb-10 question-block">
                    <label class="block text-sm font-bold mb-3 text-gray-700">
                        Q18. 映画館の特殊スペック（設備）で、あなたが重視するのはどれですか？
                        <span class="req-mark">＊</span>
                        <span class="text-xs text-gray-500 ml-2">(最大2つまで選択できます)</span>
                    </label>
                    <div class="space-y-3">
                        <div class="flex items-center">
                            <input type="checkbox" name="特殊スペック嗜好" id="spec1" value="大画面" class="mr-3" onclick="limitCheckboxes('特殊スペック嗜好', 2)">
                            <label for="spec1" class="text-sm">画面（大スクリーンなど）</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" name="特殊スペック嗜好" id="spec2" value="音響" class="mr-3" onclick="limitCheckboxes('特殊スペック嗜好', 2)">
                            <label for="spec2" class="text-sm">音響（高音質システムなど）</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" name="特殊スペック嗜好" id="spec6" value="座席快適" class="mr-3" onclick="limitCheckboxes('特殊スペック嗜好', 2)">
                            <label for="spec6" class="text-sm">座席（リクライニングシート、プレミアムシート等）</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" name="特殊スペック嗜好" id="spec7" value="映像特殊効果" class="mr-3" onclick="limitCheckboxes('特殊スペック嗜好', 2)">
                            <label for="spec7" class="text-sm">映像の特殊効果（3D, 4DX, ScreenX など）</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" name="特殊スペック嗜好" id="spec8" value="バリアフリー" class="mr-3" onclick="limitCheckboxes('特殊スペック嗜好', 2)">
                            <label for="spec8" class="text-sm">バリアフリー・アクセシビリティ（車椅子対応, UDトーク, 補聴設備等）</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" name="特殊スペック嗜好" id="spec5" value="その他" class="mr-3" onclick="limitCheckboxes('特殊スペック嗜好', 2)">
                            <label for="spec5" class="text-sm">その他</label>
                        </div>
                        <script>
                        // 最大2つまで選択可
                        function limitCheckboxes(name, max) {
                            const checkboxes = document.querySelectorAll('input[type="checkbox"][name="' + name + '"]');
                            const checked = Array.from(checkboxes).filter(cb => cb.checked);
                            if (checked.length > max) {
                                event.target.checked = false;
                            }
                        }
                        </script>
                    </div>
                </div>

                <div class="mb-10 question-block">
                    <label class="block text-sm font-bold mb-5 text-gray-700 leading-relaxed">Q19. 今回の劇場体験について、各項目の満足度を教えてください。<span class="req-mark">＊</span></label>
                    <div id="matrix-container" class="space-y-8"></div>
                </div>
            </div>

            <!-- STEP 5: サービスと次回の期待 (Q16, 18, 19, 20) -->
            <div id="step5" class="step" data-step="5" data-label="サービスと次回の期待">
                <h2 class="text-2xl font-bold mb-8 text-gray-800">サービスと次回の期待</h2>

                <div class="mb-10 question-block">
                    <label class="block text-sm font-bold mb-3 text-gray-700">Q20. 本日、この映画館を選んだ一番の理由は何ですか？<span class="req-mark">＊</span></label>
                    <div class="radio-grid">
                        <input type="radio" name="劇場選択理由" id="p_r1" value="立地が便利だから" class="hidden" required><label for="p_r1" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">立地が便利だから</label>
                        <input type="radio" name="劇場選択理由" id="p_r2" value="上映時間が都合よかったから" class="hidden"><label for="p_r2" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">上映時間が都合よかったから</label>
                        <input type="radio" name="劇場選択理由" id="p_r3" value="使いたい会員サービスがあったから" class="hidden"><label for="p_r3" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">使いたい会員サービスがあったから</label>
                        <input type="radio" name="劇場選択理由" id="p_r4" value="特別な設備で観たかったから" class="hidden"><label for="p_r4" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">特別な設備で観たかったから</label>
                        <input type="radio" name="劇場選択理由" id="p_r7" value="観たい作品がここしかやっていなかったから" class="hidden"><label for="p_r7" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">観たい作品がここしかやっていなかったから</label>
                        <input type="radio" name="劇場選択理由" id="p_r5" value="いつも利用しているから" class="hidden"><label for="p_r5" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">いつも利用しているから</label>
                        <input type="radio" name="劇場選択理由" id="p_r6" value="その他" class="hidden"><label for="p_r6" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">その他</label>
                    </div>
                </div>

                <div class="mb-10 question-block">
                    <label class="block text-sm font-bold mb-3 text-gray-700">Q21. 本日、映画館でフードやドリンクを購入しましたか？<span class="req-mark">＊</span></label>
                    <div class="radio-grid">
                        <input type="radio" name="飲食購入" id="con1" value="購入した" class="hidden" required onchange="toggleFoodSatisfaction(this)">
                        <label for="con1" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">購入した</label>
                        <input type="radio" name="飲食購入" id="con2" value="購入しなかった" class="hidden" onchange="toggleFoodSatisfaction(this)">
                        <label for="con2" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">購入しなかった</label>
                    </div>

                    <div id="foodSatisfactionBlock" class="mt-6 hidden">
                        <div class="mb-5">
                            <label class="block text-sm font-bold mb-2 text-gray-700">Q21-1. 購入した商品の満足度を教えてください。<span class="req-mark">＊</span></label>
                            <div class="flex gap-2">
                                <div class="flex-1 flex flex-col items-center">
                                    <input type="radio" name="商品満足度" id="food_sat1" value="1" class="hidden" required>
                                    <label for="food_sat1" class="border border-gray-200 py-3 w-full max-w-[48px] rounded-xl text-center cursor-pointer hover:border-blue-300 transition-all text-xs bg-white">1</label>
                                    <span class="text-[9px] text-gray-400 mt-2 text-center leading-tight">とても不満</span>
                                </div>
                                <div class="flex-1 flex flex-col items-center">
                                    <input type="radio" name="商品満足度" id="food_sat2" value="2" class="hidden" required>
                                    <label for="food_sat2" class="border border-gray-200 py-3 w-full max-w-[48px] rounded-xl text-center cursor-pointer hover:border-blue-300 transition-all text-xs bg-white">2</label>
                                </div>
                                <div class="flex-1 flex flex-col items-center">
                                    <input type="radio" name="商品満足度" id="food_sat3" value="3" class="hidden" required>
                                    <label for="food_sat3" class="border border-gray-200 py-3 w-full max-w-[48px] rounded-xl text-center cursor-pointer hover:border-blue-300 transition-all text-xs bg-white">3</label>
                                    <span class="text-[9px] text-gray-400 mt-2 text-center leading-tight">普通</span>
                                </div>
                                <div class="flex-1 flex flex-col items-center">
                                    <input type="radio" name="商品満足度" id="food_sat4" value="4" class="hidden" required>
                                    <label for="food_sat4" class="border border-gray-200 py-3 w-full max-w-[48px] rounded-xl text-center cursor-pointer hover:border-blue-300 transition-all text-xs bg-white">4</label>
                                </div>
                                <div class="flex-1 flex flex-col items-center">
                                    <input type="radio" name="商品満足度" id="food_sat5" value="5" class="hidden" required>
                                    <label for="food_sat5" class="border border-gray-200 py-3 w-full max-w-[48px] rounded-xl text-center cursor-pointer hover:border-blue-300 transition-all text-xs bg-white">5</label>
                                    <span class="text-[9px] text-gray-400 mt-2 text-center leading-tight">とても満足</span>
                                </div>
                            </div>
                        </div>
                        <div class="mb-5">
                            <label class="block text-sm font-bold mb-2 text-gray-700">Q20-2. フード・ドリンクの提供スピードの満足度を教えてください。<span class="req-mark">＊</span></label>
                            <div class="flex gap-2">
                                <div class="flex-1 flex flex-col items-center">
                                    <input type="radio" name="提供スピード満足度" id="speed_sat1" value="1" class="hidden" required>
                                    <label for="speed_sat1" class="border border-gray-200 py-3 w-full max-w-[48px] rounded-xl text-center cursor-pointer hover:border-blue-300 transition-all text-xs bg-white">1</label>
                                    <span class="text-[9px] text-gray-400 mt-2 text-center leading-tight">とても不満</span>
                                </div>
                                <div class="flex-1 flex flex-col items-center">
                                    <input type="radio" name="提供スピード満足度" id="speed_sat2" value="2" class="hidden" required>
                                    <label for="speed_sat2" class="border border-gray-200 py-3 w-full max-w-[48px] rounded-xl text-center cursor-pointer hover:border-blue-300 transition-all text-xs bg-white">2</label>
                                </div>
                                <div class="flex-1 flex flex-col items-center">
                                    <input type="radio" name="提供スピード満足度" id="speed_sat3" value="3" class="hidden" required>
                                    <label for="speed_sat3" class="border border-gray-200 py-3 w-full max-w-[48px] rounded-xl text-center cursor-pointer hover:border-blue-300 transition-all text-xs bg-white">3</label>
                                    <span class="text-[9px] text-gray-400 mt-2 text-center leading-tight">普通</span>
                                </div>
                                <div class="flex-1 flex flex-col items-center">
                                    <input type="radio" name="提供スピード満足度" id="speed_sat4" value="4" class="hidden" required>
                                    <label for="speed_sat4" class="border border-gray-200 py-3 w-full max-w-[48px] rounded-xl text-center cursor-pointer hover:border-blue-300 transition-all text-xs bg-white">4</label>
                                </div>
                                <div class="flex-1 flex flex-col items-center">
                                    <input type="radio" name="提供スピード満足度" id="speed_sat5" value="5" class="hidden" required>
                                    <label for="speed_sat5" class="border border-gray-200 py-3 w-full max-w-[48px] rounded-xl text-center cursor-pointer hover:border-blue-300 transition-all text-xs bg-white">5</label>
                                    <span class="text-[9px] text-gray-400 mt-2 text-center leading-tight">とても満足</span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-2 text-gray-700">Q20-3. フードやドリンクのラインナップの満足度を教えてください。<span class="req-mark">＊</span></label>
                            <div class="flex gap-2">
                                <div class="flex-1 flex flex-col items-center">
                                    <input type="radio" name="ラインナップ満足度" id="lineup_sat1" value="1" class="hidden" required>
                                    <label for="lineup_sat1" class="border border-gray-200 py-3 w-full max-w-[48px] rounded-xl text-center cursor-pointer hover:border-blue-300 transition-all text-xs bg-white">1</label>
                                    <span class="text-[9px] text-gray-400 mt-2 text-center leading-tight">とても不満</span>
                                </div>
                                <div class="flex-1 flex flex-col items-center">
                                    <input type="radio" name="ラインナップ満足度" id="lineup_sat2" value="2" class="hidden" required>
                                    <label for="lineup_sat2" class="border border-gray-200 py-3 w-full max-w-[48px] rounded-xl text-center cursor-pointer hover:border-blue-300 transition-all text-xs bg-white">2</label>
                                </div>
                                <div class="flex-1 flex flex-col items-center">
                                    <input type="radio" name="ラインナップ満足度" id="lineup_sat3" value="3" class="hidden" required>
                                    <label for="lineup_sat3" class="border border-gray-200 py-3 w-full max-w-[48px] rounded-xl text-center cursor-pointer hover:border-blue-300 transition-all text-xs bg-white">3</label>
                                    <span class="text-[9px] text-gray-400 mt-2 text-center leading-tight">普通</span>
                                </div>
                                <div class="flex-1 flex flex-col items-center">
                                    <input type="radio" name="ラインナップ満足度" id="lineup_sat4" value="4" class="hidden" required>
                                    <label for="lineup_sat4" class="border border-gray-200 py-3 w-full max-w-[48px] rounded-xl text-center cursor-pointer hover:border-blue-300 transition-all text-xs bg-white">4</label>
                                </div>
                                <div class="flex-1 flex flex-col items-center">
                                    <input type="radio" name="ラインナップ満足度" id="lineup_sat5" value="5" class="hidden" required>
                                    <label for="lineup_sat5" class="border border-gray-200 py-3 w-full max-w-[48px] rounded-xl text-center cursor-pointer hover:border-blue-300 transition-all text-xs bg-white">5</label>
                                    <span class="text-[9px] text-gray-400 mt-2 text-center leading-tight">とても満足</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <script>
                        function toggleFoodSatisfaction(el) {
                            const block = document.getElementById('foodSatisfactionBlock');
                            if (el.value === '購入した') {
                                block.classList.remove('hidden');
                                // Set required to true for inner radios
                                Array.from(block.querySelectorAll('input[type=radio]')).forEach(radio => {
                                    radio.required = true;
                                });
                            } else {
                                block.classList.add('hidden');
                                // Remove checked for inner radios and disable required
                                Array.from(block.querySelectorAll('input[type=radio]')).forEach(radio => {
                                    radio.checked = false;
                                    radio.required = false;
                                });
                            }
                        }
                    </script>
                </div>

                <div class="mb-10 question-block">
                    <label class="block text-sm font-bold mb-3 text-gray-700">Q22. 映画館へのご希望やご意見がございましたら、お聞かせください。（任意）</label>
                    <textarea name="劇場意見" rows="3" class="w-full p-4 border border-gray-200 rounded-xl bg-white outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all" placeholder="こちらにご記入ください"></textarea>
                </div>

                <div class="mb-10 question-block">
                    <label class="block text-sm font-bold mb-3 text-gray-700">Q23. 今後公開予定の作品で、もっとも「鑑賞したい」思う作品を教えてください。<span class="req-mark">＊</span></label>
                    <div class="radio-grid mb-4">
                        <input type="radio" name="次回鑑賞期待作" id="up1" value="ミッション：インポッシブル／ファイナル・レコニング" onchange="toggleQ20OtherRadio(this)" class="hidden" required><label for="up1" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">ミッション：インポッシブル／ファイナル・レコニング</label>
                        <input type="radio" name="次回鑑賞期待作" id="up2" value="ソニック × シャドウ TOKYO MISSION" onchange="toggleQ20OtherRadio(this)" class="hidden"><label for="up2" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">ソニック × シャドウ TOKYO MISSION</label>
                        <input type="radio" name="次回鑑賞期待作" id="up3" value="室町無頼" onchange="toggleQ20OtherRadio(this)" class="hidden"><label for="up3" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">室町無頼</label>
                        <input type="radio" name="次回鑑賞期待作" id="up4" value="スノー・ホワイト" onchange="toggleQ20OtherRadio(this)" class="hidden"><label for="up4" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">スノー・ホワイト</label>
                        <input type="radio" name="次回鑑賞期待作" id="up5" value="ババンババンバンバンパイア" onchange="toggleQ20OtherRadio(this)" class="hidden"><label for="up5" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">ババンババンバンバンパイア</label>
                        <input type="radio" name="次回鑑賞期待作" id="up6" value="サンダーボルト＊" onchange="toggleQ20OtherRadio(this)" class="hidden"><label for="up6" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">サンダーボルト＊</label>
                        <input type="radio" name="次回鑑賞期待作" id="up7" value="28年後…" onchange="toggleQ20OtherRadio(this)" class="hidden"><label for="up7" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">28年後…</label>
                        <input type="radio" name="次回鑑賞期待作" id="up8" value="スーパーマン" onchange="toggleQ20OtherRadio(this)" class="hidden"><label for="up8" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">スーパーマン</label>
                        <input type="radio" name="次回鑑賞期待作" id="up9" value="キャプテン・アメリカ：ブレイブ・ニュー・ワールド" onchange="toggleQ20OtherRadio(this)" class="hidden"><label for="up9" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">キャプテン・アメリカ：ブレイブ・ニュー・ワールド</label>
                        <input type="radio" name="次回鑑賞期待作" id="up10" value="アバター：ファイヤー・アンド・アッシュ" onchange="toggleQ20OtherRadio(this)" class="hidden"><label for="up10" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">アバター：ファイヤー・アンド・アッシュ</label>
                        <input type="radio" name="次回鑑賞期待作" id="up_other" value="その他" onchange="toggleQ20OtherRadio(this)" class="hidden"><label for="up_other" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">その他</label>
                    </div>
                    <div id="q20_other_container" class="mt-3 hidden">
                        <input type="text" id="q20_other_input" name="次回期待作自由入力" class="w-full p-4 border border-gray-200 rounded-xl bg-white outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all" placeholder="作品名をご記入ください">
                    </div>
                </div>
            </div>

            <!-- STEP 6: お客様について・普段の鑑賞について -->
            <div id="step6" class="step" data-step="6" data-label="お客様・普段の鑑賞について">
                <h2 class="text-2xl font-bold mb-8 text-gray-800">お客様・普段の鑑賞について</h2>

                <div class="mb-10 question-block">
                    <label class="block text-sm font-bold mb-3 text-gray-700">Q24. 映画館で鑑賞する際に最も魅力に感じることは何ですか？<span class="req-mark">＊</span></label>
                    <div class="space-y-2">
                        <div class="flex items-center"><input type="radio" name="映画館の魅力" id="m_c1" value="没入感" class="mr-3" required><label for="m_c1" class="text-sm">大画面・音響による没入感</label></div>
                        <div class="flex items-center"><input type="radio" name="映画館の魅力" id="m_c2" value="集中できる環境" class="mr-3"><label for="m_c2" class="text-sm">作品に集中できる環境</label></div>
                        <div class="flex items-center"><input type="radio" name="映画館の魅力" id="m_c3" value="非日常" class="mr-3"><label for="m_c3" class="text-sm">非日常的な体験</label></div>
                        <div class="flex items-center"><input type="radio" name="映画館の魅力" id="m_c4" value="感動" class="mr-3"><label for="m_c4" class="text-sm">深い感動や心の高まり</label></div>
                        <div class="flex items-center"><input type="radio" name="映画館の魅力" id="m_c5" value="一体感" class="mr-3"><label for="m_c5" class="text-sm">他の観客との一体感</label></div>
                        <div class="flex items-center"><input type="radio" name="映画館の魅力" id="m_c6" value="イベント感" class="mr-3"><label for="m_c6" class="text-sm">映画館へ行くというイベント感</label></div>
                        <div class="flex items-center"><input type="radio" name="映画館の魅力" id="m_c7" value="その他" class="mr-3"><label for="m_c7" class="text-sm">その他</label></div>
                    </div>
                </div>

                <div class="mb-10 question-block">
                    <label class="block text-sm font-bold mb-3 text-gray-700">Q25. 性別と年代をお聞かせください。<span class="req-mark">＊</span></label>
                    <div class="mb-6">
                        <p class="text-xs font-bold text-gray-400 mb-3">性別</p>
                        <div class="radio-grid">
                            <input type="radio" name="性別" id="g_m" value="男性" class="hidden" required><label for="g_m" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">男性</label>
                            <input type="radio" name="性別" id="g_f" value="女性" class="hidden"><label for="g_f" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">女性</label>
                            <input type="radio" name="性別" id="g_o" value="その他" class="hidden"><label for="g_o" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">その他/回答しない</label>
                        </div>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-gray-400 mb-3">年代</p>
                        <div class="radio-grid">
                            <input type="radio" name="年代" id="a1" value="15歳未満" class="hidden" required><label for="a1" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">15歳未満</label>
                            <input type="radio" name="年代" id="a2" value="15～19歳" class="hidden"><label for="a2" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">15～19歳</label>
                            <input type="radio" name="年代" id="a3" value="20代" class="hidden"><label for="a3" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">20代</label>
                            <input type="radio" name="年代" id="a4" value="30代" class="hidden"><label for="a4" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">30代</label>
                            <input type="radio" name="年代" id="a5" value="40代" class="hidden"><label for="a5" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">40代</label>
                            <input type="radio" name="年代" id="a6" value="50代" class="hidden"><label for="a6" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">50代</label>
                            <input type="radio" name="年代" id="a7" value="60代" class="hidden"><label for="a7" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">60代</label>
                            <input type="radio" name="年代" id="a8" value="70代以上" class="hidden"><label for="a8" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">70代以上</label>
                        </div>
                    </div>
                </div>

                <div class="mb-10 question-block">
                    <label class="block text-sm font-bold mb-3 text-gray-700">Q26. 映画館での鑑賞頻度（年間）を教えてください。<span class="req-mark">＊</span></label>
                    <div class="radio-grid">
                        <input type="radio" name="鑑賞頻度" id="fr1" value="年1～4回" class="hidden" required><label for="fr1" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">年1～4回</label>
                        <input type="radio" name="鑑賞頻度" id="fr2" value="年5～11回" class="hidden"><label for="fr2" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">年5～11回</label>
                        <input type="radio" name="鑑賞頻度" id="fr3" value="年12回以上" class="hidden"><label for="fr3" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">年12回以上</label>
                    </div>
                </div>

                <div class="mb-10 question-block">
                    <label class="block text-sm font-bold mb-3 text-gray-700">Q27. （今回を除いて）前回映画館で鑑賞したのはいつ頃ですか？<span class="req-mark">＊</span></label>
                    <div class="radio-grid">
                        <input type="radio" name="前回鑑賞" id="las1" value="1週間以内" class="hidden" required><label for="las1" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">1週間以内</label>
                        <input type="radio" name="前回鑑賞" id="las2" value="1ヶ月以内" class="hidden"><label for="las2" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">1ヶ月以内</label>
                        <input type="radio" name="前回鑑賞" id="las3" value="3ヶ月以内" class="hidden"><label for="las3" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">3ヶ月以内</label>
                        <input type="radio" name="前回鑑賞" id="las4" value="半年以内" class="hidden"><label for="las4" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">半年以内</label>
                        <input type="radio" name="前回鑑賞" id="las5" value="1年以内" class="hidden"><label for="las5" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">1年以内</label>
                        <input type="radio" name="前回鑑賞" id="las6" value="1年以上" class="hidden"><label for="las6" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">1年以上</label>
                        <input type="radio" name="前回鑑賞" id="las7" value="初めて" class="hidden"><label for="las7" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">初めて</label>
                    </div>
                </div>
            </div>

            <!-- STEP 7: ご連絡先（プレゼント応募・規約） -->
            <div id="step7" class="step" data-step="7" data-label="ご連絡先">
                <h2 class="text-2xl font-bold mb-2 text-gray-800">抽選で映画鑑賞券をプレゼント！</h2>
                <p class="text-sm text-gray-500 mb-8 leading-relaxed">アンケートにご協力いただいた感謝として、抽選で素敵なプレゼントをご用意しています。応募されますか？</p>

                <div class="mb-10 question-block">
                    <label class="block text-sm font-bold mb-3 text-gray-700">プレゼントに応募されますか？<span class="req-mark">＊</span></label>
                    <div class="radio-grid">
                        <input type="radio" name="プレゼント応募" id="p_yes" value="応募する" onchange="toggleEmail(true)" class="hidden" required>
                        <label for="p_yes" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">応募する</label>

                        <input type="radio" name="プレゼント応募" id="p_no" value="しない" onchange="toggleEmail(false)" class="hidden">
                        <label for="p_no" class="border border-gray-200 p-3 rounded-xl text-center text-xs font-bold cursor-pointer hover:bg-gray-50 bg-white">しない</label>
                    </div>
                </div>

                <!-- 応募選択時のみ表示 -->
                <div id="emailSection" class="hidden animate-slideUp">
                    <div class="mb-8">
                        <p class="text-xs font-bold text-gray-500 mb-3">個人情報の取り扱いについて</p>
                        <div class="terms-box">
                            【個人情報の取り扱いについて】<br>
                            本アンケートは、主催者「映画館に行こう実行委員会」より委託された株式会社ガイエ（以下ガイエ）が運営しています。 ご入力いただいたメールアドレスおよびご回答内容は、ガイエが下記の目的のために利用し、当社のプライバシーポリシーに基づき責任をもって厳重に管理いたします。<br><br>
                            １．利用目的<br>
                            ・映画に関する情報提供 ガイエからの、新作映画情報、関連ニュース、お得なキャンペーン等のご案内メールの配信 、および映画に関連する新しいサービスのご案内をお送りする場合があります。<br>
                            ・パーソナライズされたご案内の配信 映画配給会社等のパートナー企業からの委託を受け、ガイエが送信する、お客様のアンケート回答内容（好きなジャンル、鑑賞した作品の評価など）や属性情報（年代・性別など）に応じた、新作映画情報、限定クーポン、特別試写会等のご案内メールの配信<br>
                            ・本アンケートに関連した広告表示 ご回答内容や属性情報を分析し、本アンケートの回答完了画面において、お客様の興味・関心に合わせた広告（新作映画情報、関連サービス等）を表示するため<br>
                            ・アンケート・調査へのご協力依頼 本アンケートに関する追加のご質問や、特定のテーマに関するインタビューへのご協力依頼<br>
                            ・属性情報と関連付けた分析 ご登録いただいたメールアドレスと今回のアンケートご回答内容を関連付け、ターゲティング広告配信のためのセグメント作成、および、よりパーソナライズされた情報をお届けするための分析に利用します。<br><br>
                            ２．個人情報の第三者提供について ご本人の同意なく、メールアドレスそのものを「映画館に行こう実行委員会」の参加企業や、映画配給会社等の第三者に開示または提供することは一切ございません。 （※当社がパートナー企業に代わって、当社からお客様にメールを送信する形式をとります）<br><br>
                            ３．登録の解除について 配信されるご案内メールは、メール内に記載のURLから、いつでも簡単に配信停止（オプトアウト）の手続きが可能です。<br><br>
                            ４. プライバシーポリシー 当社の個人情報の取り扱いに関する詳細については、下記リンクより当社のプライバシーポリシーをご確認ください。<br>
                            　株式会社ガイエ プライバシーポリシー【個人情報の取り扱いについて】
                        </div>
                    </div>

                    <div class="mb-10 question-block bg-white border border-gray-100 p-6 rounded-2xl shadow-sm">
                        <label class="block text-sm font-bold mb-3 text-gray-700">Q28. メールアドレスを教えてください。<span class="req-mark">＊</span></label>
                        <input type="email" name="メールアドレス" id="emailInput" class="w-full p-4 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all" placeholder="example@mail.com">
                        <p class="text-[10px] text-gray-400 mt-4 leading-relaxed italic">※上記内容に同意の上、正確なアドレスをご記入ください。</p>
                    </div>
                </div>
            </div>

            <!-- ナビゲーション -->
            <div class="flex justify-between items-center mt-12 pt-8 border-t border-gray-100">
                <button type="button" id="prevBtn" onclick="changeStep(-1)" class="hidden px-8 py-4 text-gray-400 font-bold hover:text-gray-600 transition-all">戻る</button>
                <div class="flex-1"></div>
                <button type="button" id="nextBtn" onclick="changeStep(1)" class="bg-gray-900 text-white px-12 py-4 rounded-2xl font-bold hover:bg-gray-800 transition-all shadow-lg shadow-gray-200">次へ</button>
                <button type="submit" id="submitBtn" class="hidden bg-blue-600 text-white px-10 py-4 rounded-2xl font-bold hover:bg-blue-700 transition-all shadow-lg shadow-blue-200">
                    <span id="spinner" class="hidden animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>
                    <span id="btnText">アンケートを送信する</span>
                </button>
            </div>
        </form>

        <div id="thanksPage" class="hidden text-center py-20 animate-slideUp">
            <div class="inline-flex items-center justify-center w-20 h-20 bg-green-100 text-green-600 rounded-full mb-8">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg>
            </div>
            <h2 class="text-3xl font-black mb-4 text-gray-900">ご回答ありがとうございました</h2>
            <p class="text-gray-500 leading-relaxed mb-6">お客様の貴重なご意見は、今後の作品選びや<br>劇場サービスの向上に役立てさせていただきます。</p>
            <div id="presentNote" class="hidden bg-blue-50 p-4 rounded-xl text-blue-700 text-sm font-bold mb-10">
                プレゼントへの応募を受け付けました。抽選結果をお楽しみに！
            </div>
            <button onclick="location.reload()" class="text-blue-600 font-bold hover:underline">最初の画面に戻る</button>
        </div>
    </main>

    <footer class="py-10 text-center text-gray-300 text-[10px] tracking-widest uppercase">
        &copy; 2025 CAST Movie Survey System
    </footer>

    <script>
        const scriptUrl = 'https://script.google.com/macros/s/AKfycbzLBuHcdkjkP1K6L6OAxp_GcJ1QMmBZjTHjtYFcIb3nWbUPT5NZdzucQjKcGq0y2As4Ow/exec';

        let currentStep = 1;
        const totalSteps = 7;
        const matrixItems = ["アクセス・立地", "チケット購入のスムーズさ", "劇場の雰囲気・質", "トイレや館内の清潔さ", "スクリーン・音響の設備", "スタッフの接客・案内"];

        window.onload = function() {
            initRatings('q5-container', '点数_作品の推奨度');
            initRatings('q15-container', '点数_劇場の推奨度');
            initMatrix();
            updateNavigation();

            document.getElementById('surveyForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleSubmit();
            });
        };

        function initRatings(containerId, name) {
            const container = document.getElementById(containerId);
            let html = '';
            for (let i = 0; i <= 10; i++) {
                html += `
                    <div class="contents">
                        <input type="radio" name="${name}" id="${containerId}_${i}" value="${i}" class="hidden" required>
                        <label for="${containerId}_${i}" class="border border-gray-200 py-3 rounded-xl text-center text-xs cursor-pointer hover:border-blue-300 transition-all font-bold bg-white">${i}</label>
                    </div>`;
            }
            container.innerHTML = html;
        }

        function initMatrix() {
            const levels = [{v:1, t:"期待を大きく下回っていた"}, {v:2, t:"期待を少し下回っていた"}, {v:3, t:"期待通りだった"}, {v:4, t:"期待を少し上回っていた"}, {v:5, t:"期待を大きく上回っていた"}];
            const container = document.getElementById('matrix-container');
            matrixItems.forEach((item, idx) => {
                let rowHtml = `<div class="matrix-row border-b border-gray-50 pb-8 mb-8 last:border-0 last:pb-0"><p class="font-bold mb-5 text-sm text-gray-800"><span class="inline-flex items-center justify-center w-5 h-5 bg-gray-100 text-gray-400 rounded-md text-[10px] mr-2">${idx+1}</span>${item}</p><div class="flex gap-2">`;
                levels.forEach(lvl => {
                    rowHtml += `<div class="flex-1 flex flex-col items-center"><input type="radio" name="満足度_${item}" id="m_${idx}_${lvl.v}" value="${lvl.t}" class="hidden" required><label for="m_${idx}_${lvl.v}" class="w-full max-w-[48px] border border-gray-200 py-3 rounded-xl text-center cursor-pointer hover:border-blue-300 transition-all text-xs bg-white">${lvl.v}</label><span class="text-[9px] text-gray-400 mt-2 text-center leading-tight">${lvl.t.replace('期待を', '期待<br>').replace('回っていた', '回った')}</span></div>`;
                });
                rowHtml += `</div></div>`;
                container.innerHTML += rowHtml;
            });
        }

        function toggleQ1Other(el) {
            const container = document.getElementById('q1_other_container');
            const input = document.getElementById('q1_other_input');
            if (el.value === 'その他') {
                container.classList.remove('hidden');
                input.setAttribute('required', 'true');
            } else {
                container.classList.add('hidden');
                input.removeAttribute('required');
            }
        }

        function toggleQ8(el) {
            const q8Block = document.getElementById('q8-block');
            const q9Block = document.getElementById('q9-block');
            const q8Inputs = q8Block.querySelectorAll('input');
            const q9Inputs = q9Block.querySelectorAll('input');
            if (el.value === '1人で') {
                q8Block.style.display = 'none';
                q9Block.style.display = 'none';
                q8Inputs.forEach(input => {
                    input.removeAttribute('required');
                    input.checked = false;
                });
                q9Inputs.forEach(input => {
                    input.removeAttribute('required');
                    input.checked = false;
                });
            } else {
                q8Block.style.display = 'block';
                q8Inputs.forEach(input => input.setAttribute('required', 'true'));
            }
        }

        function toggleQ9(el) {
            const q9Block = document.getElementById('q9-block');
            const q9Inputs = q9Block.querySelectorAll('input');
            if (el && el.checked) {
                q9Block.style.display = 'block';
                // チェックボックスの必須チェックは、少なくとも1つ選択されていることを確認する必要がある
                // ここではrequired属性は設定せず、バリデーションで確認する
            } else {
                q9Block.style.display = 'none';
                q9Inputs.forEach(input => {
                    input.checked = false;
                });
            }
        }

        // Q2の字幕・吹替などの選択解除用
        function toggleRadio(el) {
            if (el.getAttribute('data-checked') === 'true') {
                el.checked = false;
                el.setAttribute('data-checked', 'false');
            } else {
                const name = el.getAttribute('name');
                document.querySelectorAll(`input[name="${name}"]`).forEach(radio => {
                    radio.setAttribute('data-checked', 'false');
                });
                el.setAttribute('data-checked', 'true');
            }
        }

        function toggleEmail(show) {
            const section = document.getElementById('emailSection');
            const input = document.getElementById('emailInput');
            if (show) {
                section.classList.remove('hidden');
                input.setAttribute('required', 'true');
            } else {
                section.classList.add('hidden');
                input.removeAttribute('required');
                input.value = '';
            }
        }

        function toggleQ20OtherRadio(el) {
            const container = document.getElementById('q20_other_container');
            const input = document.getElementById('q20_other_input');
            if (el.value === 'その他') {
                container.classList.remove('hidden');
                input.setAttribute('required', 'true');
            } else {
                container.classList.add('hidden');
                input.removeAttribute('required');
            }
        }

        function changeStep(n) {
            if (n > 0 && !validateStep(currentStep)) return;
            const steps = document.querySelectorAll('.step');
            steps[currentStep - 1].classList.remove('active');
            currentStep += n;
            steps[currentStep - 1].classList.add('active');
            updateNavigation();
            window.scrollTo(0, 0);
        }

        function updateNavigation() {
            document.getElementById('prevBtn').classList.toggle('hidden', currentStep === 1);
            document.getElementById('nextBtn').classList.toggle('hidden', currentStep === totalSteps);
            document.getElementById('submitBtn').classList.toggle('hidden', currentStep !== totalSteps);
            const progress = (currentStep / totalSteps * 100);
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('stepIndicator').innerHTML = `${currentStep.toString().padStart(2, '0')} <span class="text-sm font-normal text-gray-400">/ 0${totalSteps}</span>`;
            const activeStep = document.querySelector('.step.active');
            document.getElementById('categoryLabel').innerText = activeStep ? activeStep.dataset.label : '';
        }

        function validateStep(step) {
            const el = document.querySelector(`.step[data-step="${step}"]`);
            const blocks = el.querySelectorAll('.question-block');
            let isValid = true;
            let firstInvalid = null;

            blocks.forEach(block => {
                if (block.style.display === 'none' || block.closest('.hidden')) return;

                const inputs = block.querySelectorAll('input, textarea');
                if (inputs.length === 0) return;

                let answered = false;

                // 字幕・吹替（音声形式）は必須チェックから除外（洋画のみのため）
                if (inputs[0].name === '音声形式') {
                    answered = true;
                } else if (inputs[0].type === 'checkbox' && inputs[0].name === '同伴者年代') {
                    // 同伴者年代のチェックボックス：表示されている場合、少なくとも1つ選択されている必要がある
                    const checkedBoxes = block.querySelectorAll('input[type="checkbox"][name="同伴者年代"]:checked');
                    answered = checkedBoxes.length > 0;
                } else {
                    const req = inputs[0].hasAttribute('required') || (inputs[0].type === 'radio' && inputs[0].required);

                    if (!req) {
                        answered = true;
                    } else if (inputs[0].type === 'radio') {
                        const name = inputs[0].name;
                        answered = el.querySelector(`input[name="${name}"]:checked`) !== null;
                    } else if (inputs[0].type === 'email' || inputs[0].type === 'text') {
                        answered = inputs[0].value.trim() !== "";
                    } else if (inputs[0].tagName === 'TEXTAREA') {
                        answered = true; // 任意項目
                    }
                }

                const matrixRows = block.querySelectorAll('.matrix-row');
                if (matrixRows.length > 0) {
                    let allRowsFilled = true;
                    matrixItems.forEach(item => {
                        if (!el.querySelector(`input[name="満足度_${item}"]:checked`)) allRowsFilled = false;
                    });
                    answered = allRowsFilled;
                }

                if (!answered) {
                    isValid = false;
                    if (!firstInvalid) firstInvalid = block;
                    block.classList.add('has-error');
                } else {
                    block.classList.remove('has-error');
                }
            });

            if (firstInvalid) firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return isValid;
        }

        async function handleSubmit() {
            const submitBtn = document.getElementById('submitBtn');
            const spinner = document.getElementById('spinner');
            const btnText = document.getElementById('btnText');
            submitBtn.disabled = true;
            spinner.classList.remove('hidden');
            btnText.innerText = '送信中...';

            const form = document.getElementById('surveyForm');
            const formData = new FormData(form);
            const object = { "回答日時": new Date().toLocaleString("ja-JP") };
            
            // チェックボックスの値を配列として取得
            const checkboxGroups = {};
            form.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                if (checkbox.checked) {
                    const name = checkbox.name;
                    if (!checkboxGroups[name]) {
                        checkboxGroups[name] = [];
                    }
                    checkboxGroups[name].push(checkbox.value);
                }
            });
            
            // FormDataから通常の値を取得
            formData.forEach((value, key) => { 
                // チェックボックスの場合は配列を使用
                if (checkboxGroups[key]) {
                    object[key] = checkboxGroups[key].join(', ');
                } else {
                    object[key] = value;
                }
            });
            
            // チェックボックスでFormDataに含まれていないものも追加
            Object.keys(checkboxGroups).forEach(key => {
                if (!object[key]) {
                    object[key] = checkboxGroups[key].join(', ');
                }
            });

            if (object['作品名'] === 'その他' && object['作品名_自由入力']) {
                object['作品名'] = 'その他：' + object['作品名_自由入力'];
            }
            if (object['次回鑑賞期待作'] === 'その他' && object['次回期待作自由入力']) {
                object['次回鑑賞期待作'] = 'その他：' + object['次回期待作自由入力'];
            }

            try {
                await fetch(scriptUrl, { method: "POST", mode: "no-cors", headers: { "Content-Type": "application/json" }, body: JSON.stringify(object) });
                document.getElementById('surveyForm').classList.add('hidden');
                document.getElementById('headerArea').classList.add('hidden');
                document.getElementById('thanksPage').classList.remove('hidden');
                if (object['プレゼント応募'] === '応募する') {
                    document.getElementById('presentNote').classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error:", error);
                alert('送信に失敗しました。ネットワーク環境を確認してください。');
                submitBtn.disabled = false;
                spinner.classList.add('hidden');
                btnText.innerText = 'アンケートを送信する';
            }
            window.scrollTo(0, 0);
        }
    </script>
</body>
</html>
